# Neskuchka [![Coverage Status](https://coveralls.io/repos/github/healthy-heroes/neskuchka/badge.svg?branch=main)](https://coveralls.io/github/healthy-heroes/neskuchka?branch=main)

Проект для тренировок


## Разработка
Выполняем: `mise run info`, если не работает - надо настроить окружение

###  Настройка окружения
Поставить [mise](https://mise.jdx.dev/)

Клонируем репозиторий и устанавливаем зависимости
```
git clone git@github.com:healthy-heroes/neskuchka.git
cd neskuchka

# Добавляем конфиг файл `.mise.toml` в доверяемые 
mise trust --all
```

Настраиваем pre-коммитные хуки, чтобы автоматически запускать линтинг перед каждым коммитом.

[Фича экспериментальная](https://mise.jdx.dev/cli/generate/git-pre-commit.html), поэтому её нужно предварительно включить:

```
mise settings experimental=true
mise generate git-pre-commit --write --task=pre-commit
```

**Для Windows**
Для разработки рекомендуется использовать WSL 2, а для запуска docker-compose должна быть включена [интеграция с WSL](https://docs.docker.com/desktop/features/wsl/)


### Запуск локального сервера
Бэкенд можно поднимать локально или в Docker-контейнере. Контейнер хранит собранный фронтенд, поэтому не будет подхватывать изменения на фронтенде.

При разработке бэкенд можно поднимать в контейнере или локально, зависит от предпочтений. В контейнере удобнее, когда не нужно постоянно обновлять фронтенд и достаточно собранной версии посмотреть на работоспособность. В остальном разницы практически нет.

Локальная база монтируется в контейнер с диска. Чтобы в ней что-то было, стоит её заполнить (см. ниже).

#### Запуск бэкенда в контейнере
Для запуска выполнить команду:
```
docker compose -f 'docker-dev-compose.yml' up -d --build 
```

После бэкенд будет доступен на http://localhost:8080/

После внесенных изменений тесты запускать локально и перезапустить команду.
Контейнер не запустится, если тесты или линтер упадут.

Запуск тестов и линта:
```
mise run lint
```

#### Запуск бэкенда локально
Запуск производится с помощью `air`, которая прилетает через `mise`. `air` - это вотчер, конфигурация лежит в `app/.air.toml`, там же параметры запуска

```
# Переходим в папку бэкенда
cd backend

# Устанавливаем зависимости
go mod tidy

# Проинициализировать базу, чтобы локально хоть что-то было
go run scripts/fill_db/fill_db.go

# Запуск локального сервера
cd app
air
```

### Запуск локального фронтенда
Для активной разработки фронтенда нужно его запустить локально:

```
cd frontend

# Устанавливаем зависимости
mise run install
```

Фронтенд запускается с проксей, которая перенаправляет запросы `*/api` в бекенд на localhost, в какой порт указывается переменной окружения `VITE_BACKEND_PORT`

Для удобства есть есть две команды с преднастроенными портами (при условии, что их не меняли при поднятии бекенда или докера)

```
pnpm run dev        # фронт нацелен на докер (http://localhost:8080/)

pnpm run dev2back   # Фронт нацелен на локальный бек (http://localhost:8000/)
```

В обоих случаях фронт поднимается на http://localhost:5173/ с вотчером изменений.





