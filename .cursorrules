# Project Rules and Conventions

## Project Structure
- Monorepo: `backend/` (Go) and `frontend/` (TypeScript/React)
- Use `mise run` for all tasks (not direct `pnpm`, `go`, etc.)
- From root use prefixes: `mise run //frontend:checks --fix`, `mise run //backend:tests`
- From subdirectory, omit prefix: `cd frontend && mise run checks --fix`
- Pre-commit hooks run checks — ensure formatting is correct before committing

## Frontend
- Stack: React + Mantine UI + TanStack Router + TanStack Query
- Auth state via `useAuth()` hook from `@/auth/hooks`
- Auth redirects: in Page components using `<Navigate to="..." />`, not route-level `beforeLoad`
- Loading states: `<PageSkeleton />`, route links: `<RouteLink />`
- Route guards: `<RequireAuth>` for auth-only, `<TrackOwnerOnly>` for owner-only — wrap page component
- See `docs/concepts/routing.md` and `docs/concepts/queries.md` for details

## TanStack Query (React Query v5)
- Use `isPending` instead of `isLoading` for checking loading state
- Prefer `data?.field` over `isSuccess && data.field` for simple cases
- Use `select` option to unwrap API responses (e.g., `{ data: T }` → `T`)
- Layout components load shared data; children get it from cache instantly

## Permissions & Authorization
- Backend returns `IsOwner: bool` in API response, not raw `OwnerID`
- Frontend checks permissions via response field, not by comparing IDs

## Backend Architecture (Go)
- Layers: API handlers → Domain (Store) → Storage (dataStorage interface)
- Authentication: middleware level (session)
- Authorization (permission checks): domain level (Store methods), not handlers
- Domain errors: ErrNotFound, ErrForbidden — handlers map them via `httpx.RenderDomainError`
- API is RPC-style: client sends full objects (including IDs) in request body
- Handlers are thin: parse body → toDomain() → call Store → render response
- Business behavior on aggregates (e.g. Workout.ApplyUpdate, Workout.Ref), not on Store
- Storage interface defined in domain package (dependency inversion)
